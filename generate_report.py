from fpdf import FPDF
import datetime
import os

class MedicalReport(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 20)
        self.set_text_color(44, 62, 80)
        self.cell(0, 10, 'MediPredict AI - Diagnosis Report', 0, 1, 'C')
        self.ln(5)
        self.set_draw_color(44, 62, 80)
        self.line(10, 25, 200, 25)
        self.ln(10)

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.set_text_color(149, 165, 166)
        self.cell(0, 10, f'Page {self.page_no()} | Generated by MediPredict AI on {datetime.datetime.now().strftime("%Y-%m-%d %H:%M")}', 0, 0, 'C')

def generate_pdf_report(user_data, prediction_results, symptoms, suggested_doctors, filename="medical_report.pdf"):
    pdf = MedicalReport()
    pdf.add_page()
    
    # User Information
    pdf.set_font('Arial', 'B', 14)
    pdf.set_fill_color(236, 240, 241)
    pdf.cell(0, 10, ' Patient Information', 0, 1, 'L', fill=True)
    pdf.ln(2)
    pdf.set_font('Arial', '', 11)
    pdf.cell(95, 8, f"Name: {user_data.get('name', 'N/A')}", 0, 0)
    pdf.cell(95, 8, f"Email: {user_data.get('email', 'N/A')}", 0, 1)
    pdf.cell(95, 8, f"Age: {user_data.get('age', 'N/A')}", 0, 0)
    pdf.cell(95, 8, f"Gender: {user_data.get('gender', 'N/A')}", 0, 1)
    pdf.cell(95, 8, f"BMI: {user_data.get('bmi', 'N/A')}", 0, 0)
    pdf.cell(95, 8, f"Status: {user_data.get('bmi_category', 'N/A')}", 0, 1)
    pdf.ln(5)

    # Symptoms
    pdf.set_font('Arial', 'B', 14)
    pdf.cell(0, 10, ' Reported Symptoms', 0, 1, 'L', fill=True)
    pdf.ln(2)
    pdf.set_font('Arial', '', 11)
    symptoms_text = ", ".join(symptoms)
    pdf.multi_cell(0, 8, symptoms_text)
    pdf.ln(5)

    # Diagnosis
    pdf.set_font('Arial', 'B', 14)
    pdf.cell(0, 10, ' AI Diagnosis Results', 0, 1, 'L', fill=True)
    pdf.ln(2)
    
    top_result = prediction_results[0]
    pdf.set_font('Arial', 'B', 12)
    pdf.set_text_color(192, 57, 43)
    pdf.cell(0, 10, f"Primary Prediction: {top_result['disease']} ({top_result['confidence']} confidence)", 0, 1)
    pdf.set_text_color(0, 0, 0)
    
    # Disease Details (Expert Analysis)
    if 'info' in top_result:
        info = top_result['info']
        pdf.set_font('Arial', 'B', 11)
        pdf.cell(0, 8, 'Expert Analysis & Recommendations:', 0, 1)
        pdf.set_font('Arial', 'I', 10)
        pdf.multi_cell(0, 6, f"Description: {info.get('description', 'N/A')}")
        pdf.ln(2)
        
        pdf.set_font('Arial', 'B', 10)
        pdf.cell(50, 6, "Recommended Actions:", 0, 0)
        pdf.set_font('Arial', '', 10)
        pdf.multi_cell(0, 6, ", ".join(info.get('actions', [])))
        
        pdf.set_font('Arial', 'B', 10)
        pdf.cell(50, 6, "Key Precautions:", 0, 0)
        pdf.set_font('Arial', '', 10)
        pdf.multi_cell(0, 6, ", ".join(info.get('precautions', [])))
        
        pdf.set_font('Arial', 'B', 10)
        pdf.cell(50, 6, "Clinical Urgency:", 0, 0)
        pdf.set_font('Arial', 'B', 10)
        urgency = info.get('urgency', 'Low')
        if urgency == "High": pdf.set_text_color(192, 57, 43)
        pdf.cell(0, 6, urgency, 0, 1)
        pdf.set_text_color(0, 0, 0)
        pdf.ln(3)

    pdf.set_font('Arial', 'B', 11)
    pdf.cell(0, 8, 'Other Potential Matches:', 0, 1)
    pdf.set_font('Arial', '', 11)
    for res in prediction_results[1:]:
        pdf.cell(0, 8, f"- {res['disease']}: {res['confidence']}", 0, 1)
    pdf.ln(5)

    # Suggested Doctors
    if suggested_doctors:
        pdf.set_font('Arial', 'B', 14)
        pdf.cell(0, 10, ' Suggested Specialists Nearby', 0, 1, 'L', fill=True)
        pdf.ln(2)
        for doc in suggested_doctors:
            pdf.set_font('Arial', 'B', 11)
            pdf.cell(0, 8, f"{doc['name']} ({doc['specialty']})", 0, 1)
            pdf.set_font('Arial', '', 10)
            pdf.cell(0, 6, f"Location: {doc['location']}", 0, 1)
            pdf.cell(0, 6, f"Contact: {doc['contact']} | Rating: {doc['rating']}/5", 0, 1)
            pdf.ln(2)
    
    # Disclaimer
    pdf.ln(10)
    pdf.set_font('Arial', 'I', 9)
    pdf.set_text_color(127, 140, 141)
    disclaimer = "DISCLAIMER: This report is generated by an AI model and is for informational purposes only. It does NOT constitute medical advice. Please consult with a qualified healthcare professional for any medical concerns."
    pdf.multi_cell(0, 5, disclaimer)

    pdf.output(filename)
    return filename

if __name__ == "__main__":
    # Test generation
    test_user = {"name": "Test User", "email": "test@example.com", "age": 30, "gender": "Male", "bmi": 24.5, "bmi_category": "Normal"}
    test_results = [{"disease": "Influenza", "confidence": "92.5%"}, {"disease": "Common Cold", "confidence": "15.2%"}]
    test_symptoms = ["Fever", "Cough", "Fatigue"]
    test_docs = [{"name": "Dr. Smith", "specialty": "GP", "location": "City Clinic", "contact": "555-0123", "rating": 4.9}]
    
    generate_pdf_report(test_user, test_results, test_symptoms, test_docs, "test_report.pdf")
    print("Test report generated: test_report.pdf")
